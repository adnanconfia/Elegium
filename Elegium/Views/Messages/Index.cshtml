@{
    ViewData["Title"] = "Messages";
    Layout = null;
}

<style>
    .icon-container {
        width: 49px;
        height: 49px;
        position: relative;
    }

        .icon-container::before {
            background: #42ba96;
        }

        .icon-container.avatar-offline::before,
        .icon-container.avatar-online::before {
            position: absolute;
            border: 2px solid #fff;
            display: block;
            bottom: 0;
            right: 0;
            content: "";
            border-radius: 50%;
            -webkit-transform: translate(-10%,0);
            transform: translate(-10%,0);
            height: 10%;
            min-height: 25%;
            width: 10%;
            min-width: 25%;
        }

        .icon-container.avatar-online::before {
            background: #009688;
        }

        .icon-container.avatar-offline::before {
            background: #d70000;
        }

    .hover-files {
        visibility: hidden;
        display: flex;
    }

        .hover-files::before {
            visibility: visible;
            font-size: 20px;
            position: absolute !important;
            opacity: 1 !important;
            border: 5px dashed #0c0;
            height: 100%;
            width: 100%;
            background: url('https://www.iconfinder.com/data/icons/file-management-system-outline-1/32/file_manager_icon_set-22-512.png');
            display: inline-block;
            content: "";
            background-size: 400px 400px;
            background-repeat: no-repeat;
            background-position: 50%;
        }

        .hover-files::after {
            content: "Drop your files here!";
            position: absolute !important;
            height: 20px;
            visibility: visible;
            top: 70%;
            margin-left: 42%;
        }
</style>

<div class="section-light chat_app" ng-controller="messageCtrl" style="max-width:1300px">
    <div class="container-fluid">
        <div class="row">
            <div class="chat-lg col-lg-9 col-md-12">
                <div class="text-center font-20" style="margin-top:30%; margin-bottom:30%;" ng-hide="(ReceiverId == '' || ThreadId == '')?false:true">
                    <i class="fa fa-paper-plane"></i> <br />Select a contact to start chat
                    <a href="javascript:void(0)" class="chat_list_btn float-right"><i class="fa fa-align-right"></i></a>
                </div>
                <div class="card bg-none b-none" ng-show="(ReceiverId == '' || ThreadId == '')?false:true" id="draggableContainer">
                    <div class="card-header bline pt-1">
                        <h3 class="card-title">{{ConversationName}}<small>{{status}}</small></h3>
                        <div class="card-options">
                            <a href="javascript:void(0)" class="p-1 chat_list_btn"><i class="fa fa-align-right"></i></a>
                            <button href="javascript:void(0)" ng-disabled="$parent.hubStatus!='connected'||(ReceiverId == '' || ThreadId == '')?true:false" class="feature bg-transparent border-0" style="outline:none" data-toggle="dropdown"><i class="material-icons">settings</i></button>
                            <div class="dropdown-menu dropdown-menu-right" x-placement="bottom-end" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(18px, 24px, 0px);">
                                <a ui-sref="professionaldetails({userId:'{{ReceiverId}}'})" class="dropdown-item">
                                    <i class="dropdown-icon fa fa-user-circle"></i>View profile
                                </a>
                                <fieldset>
                                    <div class="dropdown-divider"></div>
                                    <a href="javascript:void(0)" ng-click="deleteChat(box)" class="dropdown-item">
                                        <i class="dropdown-icon fa fa-trash"></i>Delete conversation
                                    </a>
                                </fieldset>
                            </div>
                        </div>
                    </div>
                    <div class="chat_windows">
                        <div class="card p-0 m-0" ng-if="loading">
                            <div class="card-body p-0 m-0 text-center">
                                <div class="spinner-border text-center" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <ul class="mb-0 chat-ul" @*scroll-to-bottom="Messages[openedThreadId]"*@ when-scrolled="getNextPageData()" last-record="lastRecord" list-to-bottom="hasNewMessage?Messages[openedThreadId]:undefined">
                            <li class="{{item.IsItFromMe?'my-message':'other-message'}}" ng-repeat="item in Messages[openedThreadId] | orderBy: 'When':false" style="margin-bottom: 12px;margin-right: 2px" >
                                <div id="{{item.MessageId}}" class="message" style="min-width:40% !important; max-width:70% !important">
                                    <div class="{{item.IsItFromMe?'bg-light-gray':'bg-primary'}} border-radius-10 box-shadow p-1" style="width:100% !important;">
                                        <div class="card pl-3 pr-3 margin-0">
                                            <div class="card-header border-bottom font-weight-bold" style="padding:2px">
                                                <h3 class="card-title font-weight-bold" style="text-transform:none; font-size:12px">{{item.SenderName}}</h3>
                                                <h6 class="flex-grow-1  p-0 m-0 text-right">
                                                    <span class="time card-text font-10">{{item.When | date:"h:mm a"}}</span>
                                                </h6>
                                                <div class="card-options">
                                                    <div class="item-action dropdown ml-2">
                                                        <a href="javascript:void(0)" data-toggle="dropdown"><i class="fe fe-more-vertical"></i></a>
                                                        <div class="dropdown-menu dropdown-menu-right">
                                                            <a href="javascript:void(0)" ng-click="deleteMsg(item)" class="dropdown-item"><i class="dropdown-icon material-icons">delete</i> Delete</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-body {{item.IsItFromMe?'text-left':''}}" style="padding:2px">
                                                <p class="card-text font-12 p-0"> {{item.Text}}</p>
                                                <div class="row img-gallery" ng-if="item.Files.length>0">
                                                    <div class="col-sm-3" @*style="height: 100px !important;"*@ ng-repeat="file in item.Files | limitTo:4">
                                                        <a href="javascript:void(0)" ng-click="openMessageFile(item, file)" class="d-block link-overlay">
                                                            <img class="d-block img-fluid rounded" src="/api/UserProfiles/GetFileThumbnail/{{file}}/75/75" alt="" ng-style="($index+1)%4==0?{'filter': 'blur(3px)'}:{}">
                                                            <span ng-if="($index+1)%4==0?false:true" class="link-overlay-bg rounded"><i class="fa fa-search"></i></span>
                                                            <span ng-if="($index+1)%4==0" class="fa fa-2x text-white-50" style="position: absolute; top: 30%; left: 30%;">+{{item.FilesCount}}</span>
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                        <hr />
                        <div id="uppy-uploader" ng-show="hasFilesInUppy" class="w-100">

                        </div>
                        <div class="chat-message clearfix">
                            <fieldset ng-disabled="$parent.hubStatus!='connected'||(ReceiverId == '' || ThreadId == '')?true:false">

                                <div class="input-group text-black-50">

                                    <!-- Textarea -->
                                    <textarea ng-model="Text" ng-keypress="UserTypingChatBox($event)" class="form-control bg-transparent border-0" placeholder="Type your message..." rows="1" data-emoji-input="" data-autosize="true" style="overflow: hidden; overflow-wrap: break-word; resize: none; height: 46px;"></textarea>

                                    <!-- Upload button -->
                                    <input type="file" id="uppyFileDialog" multiple accept="image/*" class="displaynone" />
                                    <button ng-click="openFileFileDialog(box)" class="bg-none border-0" type="button">
                                        <span class="material-icons">attach_file</span>
                                    </button>
                                    <button class="bg-none border-0" type="button" ng-click="postMsg()" ng-keypress="UserTypingChatBox()">
                                        <span class="material-icons">send</span>
                                    </button>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="chat_list section-white" id="users">
        <a href="javascript:void(0)" class="chat_list_btn float-right"><i class="fa fa-align-right"></i></a>
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="users-tab" data-toggle="tab" href="#users-list" role="tab" aria-controls="users-list" aria-selected="true">Users</a>
            </li>
            <li class="nav-item" ng-if="false">
                <a class="nav-link" id="groups-tab" data-toggle="tab" href="#groups" role="tab" aria-controls="groups" aria-selected="false">Groups</a>
            </li>
        </ul>
        <div class="input-group mt-2 mb-2">
            <input type="text" class="form-control search" placeholder="Search...">
        </div>
        <div class="tab-content">
            <div class="tab-pane fade show active" id="users-list" role="tabpanel" aria-labelledby="users-tab">
                <nav class="nav d-block mb-n6">
                    <a class="text-reset nav-link p-0 mb-6" href="javascript:void(0);" ng-click="getChats(c)" ng-repeat="c in myConversationThreads | orderBy: 'When':true" style="outline:none">
                        <div class="card box-shadow">
                            <div class="card-body">
                                <div class="media align-items-center">
                                    <div class="icon-container {{c.Online?'avatar-online':'avatar-offline'}} mr-2">
                                        <img class="card-img rounded-circle" src="/api/UserProfiles/GetUserPhoto/{{c.UserId}}/50/50" alt="Bootstrap Themes">
                                    </div>
                                    <div class="media-body overflow-hidden">
                                        <div class="d-flex align-items-center mb-1">
                                            <h6 class="text-truncate mb-0 mr-auto" title="{{c.Name}}">{{c.Name}}</h6>
                                            <p class="small text-muted text-nowrap ml-4">{{c.FriendlyTime}}</p>
                                        </div>
                                        <div class="text-truncate" ng-if="c.isTyping?false:true" title="{{c.Text}}">{{c.Text}}</div>
                                        <div class="text-truncate" ng-if="c.isTyping">is typing...</div>
                                    </div>
                                </div>
                            </div>
                            <div ng-if="c.Read?false:true" class="badge rounded-circle badge-primary badge-border-light badge-top-right">
                                <span>{{c.UnreadMsgs}}</span>
                            </div>
                        </div>
                    </a>
                </nav>
            </div>
            <div class="tab-pane fade" id="groups" role="tabpanel" aria-labelledby="groups-tab">
                <ul class="right_chat list-unstyled list">
                    <li class="online">
                        <a href="javascript:void(0);">
                            <div class="media">
                                <img class="media-object" src="..\assets\images\xs\avatar1.jpg" alt="">
                                <div class="media-body">
                                    <span class="name">PHP Groups</span>
                                    <span class="message">How is the project coming</span>
                                    <span class="badge badge-outline status"></span>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li class="online">
                        <a href="javascript:void(0);">
                            <div class="media">
                                <img class="media-object" src="..\assets\images\xs\avatar2.jpg" alt="">
                                <div class="media-body">
                                    <span class="name">Family Groups</span>
                                    <span class="message">Update Code</span>
                                    <span class="badge badge-outline status"></span>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li class="offline">
                        <a href="javascript:void(0);">
                            <div class="media">
                                <img class="media-object" src="..\assets\images\xs\avatar3.jpg" alt="">
                                <div class="media-body">
                                    <span class="name">Harry McCall</span>
                                    <span class="message">3 New design bug</span>
                                    <span class="badge badge-outline status"></span>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li class="offline">
                        <a href="javascript:void(0);">
                            <div class="media">
                                <img class="media-object" src="..\assets\images\xs\avatar4.jpg" alt="">
                                <div class="media-body">
                                    <span class="name">Friends holic</span>
                                    <span class="message">Hello All!</span>
                                    <span class="badge badge-outline status"></span>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li class="online">
                        <a href="javascript:void(0);">
                            <div class="media">
                                <img class="media-object" src="..\assets\images\xs\avatar5.jpg" alt="">
                                <div class="media-body">
                                    <span class="name">CL City 2</span>
                                    <span class="message">Add new contact</span>
                                    <span class="badge badge-outline status"></span>
                                </div>
                            </div>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

</div>
<!-- Grid row -->

@section Scripts{
    <script src="~/js/ng-controllers/chat-module/messageCtrl.js"></script>
    <script>



        const $myForm = $('#myForm');

        $('#chat').on('click', function () {

            if ($myForm.hasClass('slim') || !$myForm.is(':visible')) {

                $myForm.css('display', 'block');
                $myForm.removeClass('slim');
            };
        })

        $('#closeButton').not('#toggle').on('click', function () {

            $myForm.hide();
        })

        $("#toggle").on('click', function () {

            $myForm.toggleClass('slim');
        });

        $("#exampleForm2").on("keypress", function (e) {
            const $eTargetVal = $(e.target).val();

            if (e.keyCode === 13 && $eTargetVal.length > 0) {
                const text =
                    `<div class="card bg-primary rounded w-75 float-right z-depth-0 mb-1 last">
                                                        <div class="card-body p-2">
                                                          <p class="card-text text-white">${$eTargetVal}</p>
                                                        </div>
                                                      </div>`;

                $(text).insertAfter(".last:last");
                $(this).val("");
            }
        });

        function getMessages(letter) {
            var div = $("#message");
            div.scrollTop(div.prop('scrollHeight'));
        }

        $(function () {
            getMessages();
        });


    </script>
}
